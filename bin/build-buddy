#!/usr/bin/env ruby

require 'rubygems'
require 'celluloid/current'
require 'methadone'
require 'build_buddy'

module BuildBuddy
  class Tool
    include Methadone::Main
    include Methadone::CLILogging

    main do |config_name|
      config_file_name = config_name

      if File.extname(config_file_name) != '.bbconfig'
        config_file_name += '.bbconfig'
      end

      load config_file_name

      config_path = File.dirname(config_file_name)
      build_log_dir  = Config.build_log_dir.gsub(/\$(\w+)/) { ENV[$1] }
      build_log_dir = File.expand_path(build_log_dir, config_path)

      unless Dir.exist?(build_log_dir)
        Dir.mkdir(build_log_dir)
      end

      Slack.configure do |config|
        config.token = Config.slack_api_token
      end

      Celluloid.logger = Reel::Logger.logger

      Celluloid::Actor[:builder] = Builder.new
      Celluloid::Actor[:slacker] = Slacker.new
      Celluloid::Actor[:gitter] = Gitter.new
      Celluloid::Actor[:scheduler] = Scheduler.new
      Celluloid::Actor[:server] = Server.new
      Celluloid::Actor[:recorder] = Recorder.new

      begin
        loop {
          sleep(5)

          unless Celluloid.actor_system.running.any? {|k| k.is_a?(BuildBuddy::Slacker)}
            Celluloid::Actor[:slacker] = Slacker.new
          end
        }
      rescue Interrupt => e
        puts
      end
    end

    version BuildBuddy::VERSION
    description 'Build Buddy'
    arg :config_name, :required

    go!
  end
end